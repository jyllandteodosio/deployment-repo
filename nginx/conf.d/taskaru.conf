# Nginx server block for the Taskaru application frontend subdomain (HTTPS)
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    server_name taskaru.jyllandteodosio.dev;

    ssl_certificate /etc/letsencrypt/live/jyllandteodosio.dev/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/jyllandteodosio.dev/privkey.pem; 

    include /etc/letsencrypt/options-ssl-nginx.conf; 
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;  

    location / {
        # Proxy requests to the taskaru-frontend service.
        proxy_pass http://taskaru-frontend:3000;

        # --- Optional: Proxy Headers ---
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # proxy_connect_timeout 60s;
        # proxy_send_timeout 60s;
        # proxy_read_timeout 60s;
    }

    access_log /var/log/nginx/taskaru_access.log main;
    error_log /var/log/nginx/taskaru_error.log warn;
}

server {
    listen 80;
    listen [::]:80;
    server_name taskaru.jyllandteodosio.dev;

    # Redirect all HTTP traffic to HTTPS.
    return 301 https://$host$request_uri;
}

# --- Nginx server block for the Taskaru API subdomain (HTTPS) ---
server {
    # Updated http2 syntax
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    server_name api.taskaru.jyllandteodosio.dev;

    ssl_certificate /etc/letsencrypt/live/jyllandteodosio.dev/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/jyllandteodosio.dev/privkey.pem;

    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        # Proxy requests to the taskaru-backend service.
        proxy_pass http://taskaru-backend:5000;

        # --- Optional: Proxy Headers ---
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    access_log /var/log/nginx/taskaru_api_access.log main;
    error_log /var/log/nginx/taskaru_api_error.log warn;
}

server {
    listen 80;
    listen [::]:80;
    server_name api.taskaru.jyllandteodosio.dev;

    # Redirect all HTTP traffic to HTTPS.
    return 301 https://$host$request_uri;
}

